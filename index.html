<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Show do Crisma</title>
    <style>
        :root {
            --bg-dark: #0a0a2a;
            --bg-light: #1a1a4a;
            --gold: #ffd700;
            --gold-dark: #b8860b;
            --silver: #c0c0c0;
            --blue-btn: #1e3c72;
            --blue-btn-hover: #2a5298;
            --green-correct: #00b894;
            --red-wrong: #d63031;
            --text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- UI GERAL --- */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        h1, h2 {
            text-transform: uppercase;
            text-align: center;
            text-shadow: var(--text-shadow);
            margin-bottom: 20px;
        }

        h1 {
            background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 2px;
        }

        /* --- LOGIN SCREEN --- */
        .login-container {
            width: 100%;
            max-width: 400px;
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--gold);
            text-align: center;
        }

        video {
            width: 100%;
            border-radius: 10px;
            border: 2px solid var(--gold);
            margin-bottom: 15px;
            background: #000;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border-radius: 30px;
            border: none;
            text-align: center;
            font-size: 1.1rem;
        }

        .btn-main {
            background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
            color: #000;
            font-weight: bold;
            padding: 15px 40px;
            border-radius: 50px;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            text-transform: uppercase;
            width: 100%;
            margin-top: 10px;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--silver);
            color: var(--silver);
            padding: 10px;
            margin-top: 15px;
            border-radius: 20px;
            width: 100%;
        }

        /* --- GAME SCREEN --- */
        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            font-size: 0.9rem;
            color: var(--gold);
            background: rgba(0,0,0,0.6);
            position: absolute;
            top: 0;
            left: 0;
        }

        .question-box {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); /* Verde Show do Milh√£o */
            width: 100%;
            max-width: 600px;
            min-height: 120px;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            margin-top: 40px;
            border: 2px solid #fff;
            position: relative;
        }

        .options-container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-btn {
            display: flex;
            align-items: stretch;
            background: linear-gradient(90deg, var(--blue-btn), var(--bg-dark));
            border: 1px solid #4a90e2;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
        }

        .option-btn:active { transform: scale(0.98); }

        .option-number {
            background: var(--gold);
            color: #000;
            font-weight: bold;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border-right: 2px solid #000;
        }

        .option-text {
            padding: 15px;
            flex-grow: 1;
            text-align: left;
            font-size: 1rem;
        }

        /* Animations for answers */
        .correct { background: var(--green-correct) !important; border-color: #fff; }
        .wrong { background: var(--red-wrong) !important; border-color: #fff; }
        .blink { animation: blinking 0.5s infinite; }

        @keyframes blinking {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* --- RANKING SCREEN --- */
        .ranking-list {
            width: 100%;
            max-width: 500px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            max-height: 50vh;
            overflow-y: auto;
            margin: 20px 0;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .ranking-item:first-child { color: var(--gold); font-weight: bold; }
        .ranking-item:nth-child(2) { color: var(--silver); }
        .ranking-item:nth-child(3) { color: #cd7f32; }

        .score-big {
            font-size: 4rem;
            color: var(--gold);
            font-weight: bold;
            margin: 10px 0;
        }

        .message-box {
            background: #fff;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }

    </style>
</head>
<body>

    <!-- AUDIO ELEMENTS (Simulados via JS AudioContext para n√£o carregar arquivos externos, mas aqui deixo placeholders l√≥gicos) -->
    
    <!-- TELA DE LOGIN -->
    <div id="screen-login" class="screen active">
        <h1>Show do Crisma</h1>
        <div class="login-container">
            <div id="camera-box" style="display:none;">
                <video id="video-preview" playsinline autoplay></video>
                <p>Aponte para o QR Code</p>
            </div>
            
            <div id="manual-box">
                <p>Digite seu ID e Nome ou escaneie o QR</p>
                <input type="text" id="input-id" placeholder="ID do Aluno (ex: 01)">
                <input type="text" id="input-name" placeholder="Primeiro Nome">
            </div>

            <div id="msg-login" class="message-box" style="background: #ffeb3b;"></div>

            <button class="btn-main" onclick="loginManual()">Entrar / Jogar</button>
            <button class="btn-secondary" onclick="toggleCamera()">üì∑ Ler QR Code</button>
            <button class="btn-secondary" style="border-color: transparent; font-size: 0.8rem;" onclick="clearData()">Limpar Dados Locais</button>
        </div>
    </div>

    <!-- TELA DE JOGO -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <span id="player-display">Aluno: ---</span>
            <span>Erros: <span id="strikes-display" style="color: var(--red-wrong)">0</span>/3</span>
            <span>Quest√£o: <span id="q-num-display">1</span>/10</span>
        </div>

        <div class="question-box">
            <span id="question-text">Carregando pergunta...</span>
        </div>

        <div class="options-container" id="options-list">
            <!-- Op√ß√µes geradas via JS -->
        </div>
    </div>

    <!-- TELA DE RESULTADO -->
    <div id="screen-result" class="screen">
        <h2>Resultado Final</h2>
        <p id="result-msg">Voc√™ completou o desafio de hoje!</p>
        
        <div class="score-big" id="final-score">0</div>
        <p>PONTOS</p>

        <h3>Ranking Local</h3>
        <div class="ranking-list" id="ranking-container">
            <!-- Ranking via JS -->
        </div>

        <button class="btn-main" onclick="logout()">Sair</button>
    </div>

    <script>
        // --- BANCO DE PERGUNTAS (40 BASE + Gerador L√≥gico) ---
        const baseQuestions = [
            { q: "Quantos s√£o os Sacramentos da Igreja Cat√≥lica?", options: ["7", "10", "3", "12"], correct: 0 },
            { q: "Qual sacramento nos torna filhos de Deus?", options: ["Crisma", "Batismo", "Eucaristia", "Ordem"], correct: 1 },
            { q: "Quem √© a terceira pessoa da Sant√≠ssima Trindade?", options: ["Jesus", "O Pai", "O Esp√≠rito Santo", "Maria"], correct: 2 },
            { q: "Qual √© o sacramento que confirma o Batismo?", options: ["Matrim√¥nio", "Eucaristia", "Un√ß√£o dos Enfermos", "Crisma"], correct: 3 },
            { q: "Qual dia da semana Jesus ressuscitou?", options: ["Sexta-feira", "S√°bado", "Domingo", "Segunda-feira"], correct: 2 },
            { q: "Quem recebeu os 10 Mandamentos?", options: ["No√©", "Mois√©s", "Abra√£o", "Davi"], correct: 1 },
            { q: "Quantos dias dura a Quaresma?", options: ["30 dias", "50 dias", "40 dias", "7 dias"], correct: 2 },
            { q: "O que celebramos no Natal?", options: ["Morte de Jesus", "Ressurrei√ß√£o de Jesus", "Nascimento de Jesus", "Batismo de Jesus"], correct: 2 },
            { q: "Qual a cor lit√∫rgica do Tempo Comum?", options: ["Roxo", "Branco", "Vermelho", "Verde"], correct: 3 },
            { q: "Quem foi a m√£e de Jesus?", options: ["Santa Ana", "Maria Madalena", "Maria", "Isabel"], correct: 2 },
            { q: "O que significa a palavra 'Eucaristia'?", options: ["Sacrif√≠cio", "A√ß√£o de Gra√ßas", "Perd√£o", "Alian√ßa"], correct: 1 },
            { q: "Quem batizou Jesus?", options: ["Pedro", "Paulo", "Jo√£o Batista", "Jos√©"], correct: 2 },
            { q: "Onde Jesus nasceu?", options: ["Nazar√©", "Jerusal√©m", "Bel√©m", "Roma"], correct: 2 },
            { q: "Qual ora√ß√£o Jesus nos ensinou?", options: ["Ave Maria", "Salve Rainha", "Pai Nosso", "Credo"], correct: 2 },
            { q: "Quem √© o sucessor de S√£o Pedro hoje?", options: ["O Bispo", "O Papa", "O Padre", "O Di√°cono"], correct: 1 },
            { q: "Qual mandamento diz 'Honrar Pai e M√£e'?", options: ["1¬∫", "2¬∫", "3¬∫", "4¬∫"], correct: 3 },
            { q: "O que √© o Crisma?", options: ["Sacramento da cura", "Sacramento do Servi√ßo", "Sacramento da Maturidade Crist√£", "Uma festa"], correct: 2 },
            { q: "Qual o s√≠mbolo do Esp√≠rito Santo no Batismo de Jesus?", options: ["Fogo", "Pomba", "Vento", "√Ågua"], correct: 1 },
            { q: "Quantos s√£o os dons do Esp√≠rito Santo?", options: ["3", "12", "7", "9"], correct: 2 },
            { q: "Qual √© o livro sagrado dos crist√£os?", options: ["Alcor√£o", "Tor√°", "B√≠blia", "Vedas"], correct: 2 },
            { q: "Quem traiu Jesus?", options: ["Pedro", "Tom√©", "Judas Iscariotes", "Tiago"], correct: 2 },
            { q: "O que celebramos na P√°scoa?", options: ["Nascimento", "Morte", "Ressurrei√ß√£o", "Ascens√£o"], correct: 2 },
            { q: "Qual o primeiro livro da B√≠blia?", options: ["G√™nesis", "√äxodo", "Salmos", "Mateus"], correct: 0 },
            { q: "Quem abriu o Mar Vermelho?", options: ["Jesus", "Mois√©s", "Elias", "Pedro"], correct: 1 },
            { q: "Qual o sacramento do perd√£o dos pecados?", options: ["Batismo", "Reconcilia√ß√£o (Confiss√£o)", "Eucaristia", "Ordem"], correct: 1 },
            { q: "Quem s√£o os quatro evangelistas?", options: ["Mateus, Marcos, Lucas e Jo√£o", "Pedro, Tiago, Jo√£o e Andr√©", "Paulo, Barnab√©, Lucas e Marcos", "Mois√©s, Elias, Isa√≠as e Jeremias"], correct: 0 },
            { q: "O que significa 'Igreja'?", options: ["Templo", "Casa de Deus", "Assembleia / Povo de Deus", "Vaticano"], correct: 2 },
            { q: "Qual a cor lit√∫rgica do Advento?", options: ["Verde", "Branco", "Roxo", "Vermelho"], correct: 2 },
            { q: "Quem negou Jesus tr√™s vezes?", options: ["Judas", "Pedro", "Tom√©", "Jo√£o"], correct: 1 },
            { q: "Em quantos dias Deus criou o mundo segundo o G√™nesis?", options: ["7", "6 (e descansou no 7¬∫)", "10", "1"], correct: 1 },
            { q: "Qual o nome do anjo que anunciou a Maria?", options: ["Miguel", "Rafael", "Gabriel", "Uriel"], correct: 2 },
            { q: "O que √© h√≥stia consagrada?", options: ["P√£o simb√≥lico", "Corpo de Cristo", "Uma bolacha", "Um memorial apenas"], correct: 1 },
            { q: "Qual mandamento pro√≠be matar?", options: ["5¬∫", "6¬∫", "7¬∫", "8¬∫"], correct: 0 },
            { q: "Quem foi o primeiro Papa?", options: ["Paulo", "Jo√£o Paulo II", "Pedro", "Francisco"], correct: 2 },
            { q: "Onde Jesus realizou seu primeiro milagre?", options: ["Can√°", "Nazar√©", "Bet√¢nia", "Jeric√≥"], correct: 0 },
            { q: "Qual o dia de guarda semanal dos cat√≥licos?", options: ["S√°bado", "Domingo", "Quarta-feira", "Sexta-feira"], correct: 1 },
            { q: "O que significa 'Am√©m'?", options: ["Obrigado", "Assim seja", "Por favor", "Adeus"], correct: 1 },
            { q: "Quem construiu a arca?", options: ["Mois√©s", "Abra√£o", "No√©", "Ad√£o"], correct: 2 },
            { q: "Qual o dom que nos d√° coragem para testemunhar a f√©?", options: ["Sabedoria", "Fortaleza", "Ci√™ncia", "Piedade"], correct: 1 },
            { q: "Como se chama a conversa com Deus?", options: ["Serm√£o", "Ora√ß√£o", "Prega√ß√£o", "Leitura"], correct: 1 }
        ];

        // Gerador de "2000" perguntas (Simula√ß√£o por Permuta√ß√£o para economizar mem√≥ria)
        function generateBigPool() {
            let bigPool = [];
            for(let i=0; i<50; i++) { // Repete o ciclo 50 vezes
                const shuffled = [...baseQuestions].sort(() => Math.random() - 0.5);
                bigPool = bigPool.concat(shuffled);
            }
            return bigPool;
        }

        // --- ESTADO DO JOGO ---
        let gameState = {
            user: null,
            questions: [],
            currentIdx: 0,
            score: 0,
            strikes: 0,
            isLocked: false
        };

        // --- L√ìGICA DE ARMAZENAMENTO (LocalStorage) ---
        const DB_KEY = 'crisma_game_db_v2';
        
        function getDB() {
            const db = localStorage.getItem(DB_KEY);
            return db ? JSON.parse(db) : { users: {}, rankings: [] };
        }

        function saveDB(data) {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
        }

        // --- CONTROLE DE TELAS ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- LOGIN & VALIDA√á√ÉO DI√ÅRIA ---
        function loginManual() {
            const id = document.getElementById('input-id').value.trim();
            const name = document.getElementById('input-name').value.trim();
            
            if(!id || !name) {
                alert("Preencha ID e Nome!");
                return;
            }
            processLogin(id, name);
        }

        function processLogin(id, name) {
            const todayKey = new Date().toLocaleDateString();
            const db = getDB();
            
            // Cria usu√°rio se n√£o existir
            if(!db.users[id]) {
                db.users[id] = { name: name, history: {} };
            }
            
            // Verifica se j√° jogou hoje 
            // EXCE√á√ÉO: ID "01" √â DE TESTE/ADMIN E N√ÉO TEM LIMITE
            if(id !== '01' && db.users[id].history[todayKey]) {
                const todayData = db.users[id].history[todayKey];
                showMsg(`Ol√° ${name}! Voc√™ j√° jogou hoje. Pontua√ß√£o: ${todayData.score}. Tente amanh√£!`);
                return;
            }
            
            // Se for ID 01, mostra um alerta discreto
            if(id === '01') {
                console.log("Modo Teste/Admin ativado: Limites ignorados.");
            }

            // Inicia Jogo
            gameState.user = { id, name };
            gameState.questions = generateBigPool().slice(0, 10); // Pega 10
            gameState.currentIdx = 0;
            gameState.score = 0;
            gameState.strikes = 0;
            gameState.isLocked = false;

            showScreen('screen-game');
            renderGame();
        }

        function showMsg(txt) {
            const el = document.getElementById('msg-login');
            el.textContent = txt;
            el.style.display = 'block';
        }

        // --- MOTOR DO JOGO ---
        function renderGame() {
            if(gameState.strikes >= 3 || gameState.currentIdx >= 10) {
                endGame();
                return;
            }

            const qData = gameState.questions[gameState.currentIdx];
            
            // Atualiza Header
            document.getElementById('player-display').textContent = `Aluno: ${gameState.user.name}`;
            document.getElementById('strikes-display').textContent = gameState.strikes;
            document.getElementById('q-num-display').textContent = gameState.currentIdx + 1;

            // Atualiza Pergunta e Op√ß√µes
            document.getElementById('question-text').textContent = qData.q;
            const optContainer = document.getElementById('options-list');
            optContainer.innerHTML = '';

            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerHTML = `
                    <div class="option-number">${idx + 1}</div>
                    <div class="option-text">${opt}</div>
                `;
                btn.onclick = () => handleAnswer(idx, btn);
                optContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedIdx, btnElement) {
            if(gameState.isLocked) return;
            gameState.isLocked = true;

            const currentQ = gameState.questions[gameState.currentIdx];
            const isCorrect = selectedIdx === currentQ.correct;

            // Feedback Visual
            btnElement.classList.add('blink'); // Pisca amarelo simulado
            
            setTimeout(() => {
                btnElement.classList.remove('blink');
                if(isCorrect) {
                    btnElement.classList.add('correct');
                    gameState.score++;
                } else {
                    btnElement.classList.add('wrong');
                    gameState.strikes++;
                    // Mostra a correta
                    const correctBtn = document.getElementById('options-list').children[currentQ.correct];
                    if(correctBtn) correctBtn.classList.add('correct');
                }

                // Espera e avan√ßa
                setTimeout(() => {
                    gameState.currentIdx++;
                    gameState.isLocked = false;
                    renderGame();
                }, 1500);

            }, 1000); // Tempo do suspense
        }

        // --- FIM DE JOGO & RANKING ---
        function endGame() {
            const db = getDB();
            const todayKey = new Date().toLocaleDateString();

            // Salva Hist√≥rico
            db.users[gameState.user.id].history[todayKey] = {
                score: gameState.score,
                date: new Date().toISOString()
            };
            saveDB(db);

            // Prepara tela final
            showScreen('screen-result');
            document.getElementById('final-score').textContent = gameState.score;
            
            const msg = document.getElementById('result-msg');
            if(gameState.strikes >= 3) msg.textContent = "Errou 3 vezes! Fim de jogo.";
            else msg.textContent = "Parab√©ns! Voc√™ completou as 10 perguntas!";

            renderRanking(db);
        }

        function renderRanking(db) {
            const list = [];
            const todayKey = new Date().toLocaleDateString();

            // Coleta scores de hoje
            Object.keys(db.users).forEach(uid => {
                const u = db.users[uid];
                if(u.history[todayKey]) {
                    list.push({ name: u.name, score: u.history[todayKey].score });
                }
            });

            // Ordena Descrescente
            list.sort((a, b) => b.score - a.score);

            const container = document.getElementById('ranking-container');
            container.innerHTML = '';
            
            list.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.innerHTML = `
                    <span>${i+1}¬∫ ${item.name}</span>
                    <span>${item.score} pts</span>
                `;
                container.appendChild(div);
            });
        }

        function logout() {
            location.reload();
        }

        function clearData() {
            if(confirm("Isso apagar√° todo o hist√≥rico e ranking de todos os alunos. Confirma?")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // --- LEITURA QR CODE (BarcodeDetector API) ---
        // Nota: Esta API funciona no Chrome/Android nativamente.
        // iOS Safari ainda n√£o suporta nativamente, por isso o fallback manual √© crucial.
        
        let stream = null;

        async function toggleCamera() {
            const camBox = document.getElementById('camera-box');
            const manualBox = document.getElementById('manual-box');
            const video = document.getElementById('video-preview');

            if (camBox.style.display === 'none') {
                // Tenta abrir c√¢mera
                try {
                    // Verifica suporte a BarcodeDetector
                    if (!('BarcodeDetector' in window)) {
                        alert("Seu navegador n√£o suporta leitura nativa de QR. Use a entrada manual.");
                        return;
                    }

                    manualBox.style.display = 'none';
                    camBox.style.display = 'block';

                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment" } 
                    });
                    video.srcObject = stream;
                    
                    startScanning();

                } catch (err) {
                    console.error(err);
                    alert("Erro ao acessar c√¢mera: " + err.message);
                    camBox.style.display = 'none';
                    manualBox.style.display = 'block';
                }
            } else {
                stopCamera();
            }
        }

        function stopCamera() {
            if(stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            document.getElementById('camera-box').style.display = 'none';
            document.getElementById('manual-box').style.display = 'block';
        }

        async function startScanning() {
            const video = document.getElementById('video-preview');
            const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });

            const detectLoop = setInterval(async () => {
                if(!stream) { clearInterval(detectLoop); return; }
                
                try {
                    const barcodes = await barcodeDetector.detect(video);
                    if (barcodes.length > 0) {
                        const rawValue = barcodes[0].rawValue; 
                        // Exemplo esperado: "123|Nome" OU "01 AGATHA BUCALON..."
                        
                        let id, name;

                        if(rawValue.includes('|')) {
                            [id, name] = rawValue.split('|');
                        } else {
                            // Tenta parsear por espa√ßo para crach√°s sem pipe
                            // Assume que a primeira palavra √© o ID
                            const parts = rawValue.trim().split(' ');
                            if(parts.length >= 2) {
                                id = parts[0];
                                name = parts.slice(1).join(' '); // Junta o resto como nome
                            }
                        }

                        if(id && name) {
                            clearInterval(detectLoop);
                            stopCamera();
                            
                            // Feedback Visual de Sucesso
                            document.body.style.backgroundColor = '#fff';
                            setTimeout(() => document.body.style.backgroundColor = '', 100);
                            
                            document.getElementById('input-id').value = id;
                            document.getElementById('input-name').value = name;
                            processLogin(id, name);
                        }
                    }
                } catch (e) {
                    // Ignora frames vazios
                }
            }, 500);
        }

    </script>
</body>
</html>
