<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Show do Crisma</title>
    <!-- Biblioteca de QR Code -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --bg-dark: #0a0a2a;
            --bg-light: #1a1a4a;
            --gold: #ffd700;
            --gold-dark: #b8860b;
            --silver: #c0c0c0;
            --blue-btn: #1e3c72;
            --blue-btn-hover: #2a5298;
            --green-correct: #00b894;
            --red-wrong: #d63031;
            --text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- UI GERAL --- */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 10px;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: absolute; /* Garante sobreposi√ß√£o correta */
            top: 0;
            left: 0;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%); /* Fundo pr√≥prio para evitar transpar√™ncia indesejada */
            z-index: 10;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            z-index: 20; /* Tela ativa sempre no topo */
        }

        h1, h2 {
            text-transform: uppercase;
            text-align: center;
            text-shadow: var(--text-shadow);
            margin-bottom: 20px;
        }

        h1 {
            background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
        }

        /* --- LOGIN SCREEN --- */
        .login-container {
            width: 100%;
            max-width: 400px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--gold);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #reader {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            background: #000;
            display: none;
        }
        
        #reader button {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #reader select { color: #000; padding: 5px; }
        #reader__dashboard_section_csr span { color: white !important; }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border-radius: 30px;
            border: none;
            text-align: center;
            font-size: 1.2rem;
        }

        .btn-main {
            background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
            color: #000;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            text-transform: uppercase;
            width: 100%;
            margin-top: 10px;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--silver);
            color: var(--silver);
            padding: 12px;
            margin-top: 15px;
            border-radius: 20px;
            width: 100%;
            font-size: 1rem;
        }

        /* --- GAME SCREEN --- */
        .game-header {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: auto auto;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(0,0,0,0.9);
            position: absolute;
            top: 0;
            left: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            z-index: 100;
            border-bottom: 2px solid var(--gold-dark);
        }

        .header-name {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 2rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 2px 4px #000;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255,215,0,0.3);
            padding-bottom: 5px;
        }

        .header-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--silver);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            line-height: 1;
            margin-top: 5px;
        }

        .question-box {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            width: 100%;
            max-width: 700px;
            min-height: 140px;
            padding: 25px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            margin-top: 180px;
            border: 3px solid #fff;
            position: relative;
        }

        .options-container {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1;
            justify-content: flex-start;
        }

        .option-btn {
            display: flex;
            align-items: stretch;
            background: linear-gradient(90deg, var(--blue-btn), var(--bg-dark));
            border: 2px solid #4a90e2;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
            min-height: 60px;
        }

        .option-btn:active { transform: scale(0.98); }

        .option-number {
            background: var(--gold);
            color: #000;
            font-weight: bold;
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-right: 2px solid #000;
        }

        .option-text {
            padding: 15px 20px;
            flex-grow: 1;
            text-align: left;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .correct { background: var(--green-correct) !important; border-color: #fff; }
        .wrong { background: var(--red-wrong) !important; border-color: #fff; }
        .blink { animation: blinking 0.5s infinite; }

        @keyframes blinking {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* --- RESULT SCREEN (FOCADA) --- */
        .result-panel {
            width: 100%;
            max-width: 600px;
            background: rgba(255,255,255,0.1);
            border: 4px solid var(--gold);
            border-radius: 20px;
            padding: 40px 20px;
            margin-bottom: 40px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result-name {
            font-size: 3rem;
            color: var(--gold);
            font-weight: 900;
            margin-bottom: 30px;
            text-shadow: 2px 2px 0 #000;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 20px;
            width: 100%;
        }

        .result-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
        }

        .result-stat-box {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .result-label {
            font-size: 1.2rem;
            color: var(--silver);
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .result-value {
            font-size: 5rem;
            font-weight: 900;
            line-height: 1;
        }

        .val-green { color: var(--green-correct); }
        .val-red { color: var(--red-wrong); }

        .message-box {
            background: #fff;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            display: none;
            width: 100%;
        }

    </style>
</head>
<body>

    <!-- TELA DE LOGIN -->
    <div id="screen-login" class="screen active">
        <h1>Show do Crisma</h1>
        <div class="login-container">
            
            <!-- Container para o Leitor de QR -->
            <div id="reader"></div>
            
            <div id="manual-box" style="width: 100%;">
                <input type="text" id="input-id" placeholder="ID do Aluno (ex: 01)">
                <input type="text" id="input-name" placeholder="Primeiro Nome">
            </div>

            <div id="msg-login" class="message-box" style="background: #ffeb3b;"></div>

            <button class="btn-main" id="btn-jogar" onclick="loginManual()">Entrar / Jogar</button>
            <button class="btn-secondary" id="btn-camera" onclick="toggleCamera()">üì∑ Abrir Leitor QR</button>
            <button class="btn-secondary" style="border-color: transparent; font-size: 0.8rem;" onclick="clearData()">Limpar Dados Locais</button>
        </div>
    </div>

    <!-- TELA DE JOGO -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <!-- Nome bem grande no topo -->
            <div class="header-name" id="player-display">ALUNO</div>
            
            <!-- Status grandes lado a lado -->
            <div class="header-stat">
                <span class="stat-label">Erros</span>
                <span class="stat-value" id="strikes-display" style="color: var(--red-wrong);">0/3</span>
            </div>
            <div class="header-stat">
                <span class="stat-label">Quest√£o</span>
                <span class="stat-value" id="q-num-display" style="color: #fff;">1/10</span>
            </div>
        </div>

        <div class="question-box">
            <span id="question-text">Carregando...</span>
        </div>

        <div class="options-container" id="options-list"></div>
    </div>

    <!-- TELA DE RESULTADO -->
    <div id="screen-result" class="screen">
        <h2>Resultado da Partida</h2>
        
        <!-- Painel de Resumo (Simplificado sem Ranking) -->
        <div class="result-panel">
            <div class="result-name" id="end-player-name">---</div>
            
            <div class="result-stats-grid">
                <div class="result-stat-box">
                    <div class="result-label">Pontua√ß√£o</div>
                    <div class="result-value val-green" id="end-score">0</div>
                </div>
                <div class="result-stat-box">
                    <div class="result-label">Erros</div>
                    <div class="result-value val-red" id="end-strikes">0</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; color: var(--silver); font-size: 1.2rem; font-weight: bold;" id="end-msg">---</div>
        </div>
        
        <button class="btn-main" onclick="logout()">Sair / Novo Jogo</button>
    </div>

    <script>
        // --- BANCO DE PERGUNTAS ---
        const baseQuestions = [
            { q: "Quantos s√£o os Sacramentos da Igreja Cat√≥lica?", options: ["7", "10", "3", "12"], correct: 0 },
            { q: "Qual sacramento nos torna filhos de Deus?", options: ["Crisma", "Batismo", "Eucaristia", "Ordem"], correct: 1 },
            { q: "Quem √© a terceira pessoa da Sant√≠ssima Trindade?", options: ["Jesus", "O Pai", "O Esp√≠rito Santo", "Maria"], correct: 2 },
            { q: "Qual √© o sacramento que confirma o Batismo?", options: ["Matrim√¥nio", "Eucaristia", "Un√ß√£o dos Enfermos", "Crisma"], correct: 3 },
            { q: "Qual dia da semana Jesus ressuscitou?", options: ["Sexta-feira", "S√°bado", "Domingo", "Segunda-feira"], correct: 2 },
            { q: "Quem recebeu os 10 Mandamentos?", options: ["No√©", "Mois√©s", "Abra√£o", "Davi"], correct: 1 },
            { q: "Quantos dias dura a Quaresma?", options: ["30 dias", "50 dias", "40 dias", "7 dias"], correct: 2 },
            { q: "O que celebramos no Natal?", options: ["Morte de Jesus", "Ressurrei√ß√£o de Jesus", "Nascimento de Jesus", "Batismo de Jesus"], correct: 2 },
            { q: "Qual a cor lit√∫rgica do Tempo Comum?", options: ["Roxo", "Branco", "Vermelho", "Verde"], correct: 3 },
            { q: "Quem foi a m√£e de Jesus?", options: ["Santa Ana", "Maria Madalena", "Maria", "Isabel"], correct: 2 },
            { q: "O que significa a palavra 'Eucaristia'?", options: ["Sacrif√≠cio", "A√ß√£o de Gra√ßas", "Perd√£o", "Alian√ßa"], correct: 1 },
            { q: "Quem batizou Jesus?", options: ["Pedro", "Paulo", "Jo√£o Batista", "Jos√©"], correct: 2 },
            { q: "Onde Jesus nasceu?", options: ["Nazar√©", "Jerusal√©m", "Bel√©m", "Roma"], correct: 2 },
            { q: "Qual ora√ß√£o Jesus nos ensinou?", options: ["Ave Maria", "Salve Rainha", "Pai Nosso", "Credo"], correct: 2 },
            { q: "Quem √© o sucessor de S√£o Pedro hoje?", options: ["O Bispo", "O Papa", "O Padre", "O Di√°cono"], correct: 1 },
            { q: "Qual mandamento diz 'Honrar Pai e M√£e'?", options: ["1¬∫", "2¬∫", "3¬∫", "4¬∫"], correct: 3 },
            { q: "O que √© o Crisma?", options: ["Sacramento da cura", "Sacramento do Servi√ßo", "Sacramento da Maturidade Crist√£", "Uma festa"], correct: 2 },
            { q: "Qual o s√≠mbolo do Esp√≠rito Santo no Batismo de Jesus?", options: ["Fogo", "Pomba", "Vento", "√Ågua"], correct: 1 },
            { q: "Quantos s√£o os dons do Esp√≠rito Santo?", options: ["3", "12", "7", "9"], correct: 2 },
            { q: "Qual √© o livro sagrado dos crist√£os?", options: ["Alcor√£o", "Tor√°", "B√≠blia", "Vedas"], correct: 2 },
            { q: "Quem traiu Jesus?", options: ["Pedro", "Tom√©", "Judas Iscariotes", "Tiago"], correct: 2 },
            { q: "O que celebramos na P√°scoa?", options: ["Nascimento", "Morte", "Ressurrei√ß√£o", "Ascens√£o"], correct: 2 },
            { q: "Qual o primeiro livro da B√≠blia?", options: ["G√™nesis", "√äxodo", "Salmos", "Mateus"], correct: 0 },
            { q: "Quem abriu o Mar Vermelho?", options: ["Jesus", "Mois√©s", "Elias", "Pedro"], correct: 1 },
            { q: "Qual o sacramento do perd√£o dos pecados?", options: ["Batismo", "Reconcilia√ß√£o (Confiss√£o)", "Eucaristia", "Ordem"], correct: 1 },
            { q: "Quem s√£o os quatro evangelistas?", options: ["Mateus, Marcos, Lucas e Jo√£o", "Pedro, Tiago, Jo√£o e Andr√©", "Paulo, Barnab√©, Lucas e Marcos", "Mois√©s, Elias, Isa√≠as e Jeremias"], correct: 0 },
            { q: "O que significa 'Igreja'?", options: ["Templo", "Casa de Deus", "Assembleia / Povo de Deus", "Vaticano"], correct: 2 },
            { q: "Qual a cor lit√∫rgica do Advento?", options: ["Verde", "Branco", "Roxo", "Vermelho"], correct: 2 },
            { q: "Quem negou Jesus tr√™s vezes?", options: ["Judas", "Pedro", "Tom√©", "Jo√£o"], correct: 1 },
            { q: "Em quantos dias Deus criou o mundo segundo o G√™nesis?", options: ["7", "6 (e descansou no 7¬∫)", "10", "1"], correct: 1 },
            { q: "Qual o nome do anjo que anunciou a Maria?", options: ["Miguel", "Rafael", "Gabriel", "Uriel"], correct: 2 },
            { q: "O que √© h√≥stia consagrada?", options: ["P√£o simb√≥lico", "Corpo de Cristo", "Uma bolacha", "Um memorial apenas"], correct: 1 },
            { q: "Qual mandamento pro√≠be matar?", options: ["5¬∫", "6¬∫", "7¬∫", "8¬∫"], correct: 0 },
            { q: "Quem foi o primeiro Papa?", options: ["Paulo", "Jo√£o Paulo II", "Pedro", "Francisco"], correct: 2 },
            { q: "Onde Jesus realizou seu primeiro milagre?", options: ["Can√°", "Nazar√©", "Bet√¢nia", "Jeric√≥"], correct: 0 },
            { q: "Qual o dia de guarda semanal dos cat√≥licos?", options: ["S√°bado", "Domingo", "Quarta-feira", "Sexta-feira"], correct: 1 },
            { q: "O que significa 'Am√©m'?", options: ["Obrigado", "Assim seja", "Por favor", "Adeus"], correct: 1 },
            { q: "Quem construiu a arca?", options: ["Mois√©s", "Abra√£o", "No√©", "Ad√£o"], correct: 2 },
            { q: "Qual o dom que nos d√° coragem para testemunhar a f√©?", options: ["Sabedoria", "Fortaleza", "Ci√™ncia", "Piedade"], correct: 1 },
            { q: "Como se chama a conversa com Deus?", options: ["Serm√£o", "Ora√ß√£o", "Prega√ß√£o", "Leitura"], correct: 1 }
        ];

        function generateBigPool() {
            let bigPool = [];
            for(let i=0; i<50; i++) {
                const shuffled = [...baseQuestions].sort(() => Math.random() - 0.5);
                bigPool = bigPool.concat(shuffled);
            }
            return bigPool;
        }

        // --- ESTADO DO JOGO ---
        let gameState = { user: null, questions: [], currentIdx: 0, score: 0, strikes: 0, isLocked: false };
        const DB_KEY = 'crisma_game_db_v2';
        
        function getDB() { return localStorage.getItem(DB_KEY) ? JSON.parse(localStorage.getItem(DB_KEY)) : { users: {}, rankings: [] }; }
        function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- LOGIN LOGIC ---
        function loginManual() {
            const id = document.getElementById('input-id').value.trim();
            const name = document.getElementById('input-name').value.trim();
            if(!id || !name) { alert("Preencha ID e Nome!"); return; }
            processLogin(id, name);
        }

        function processLogin(id, name) {
            const todayKey = new Date().toLocaleDateString();
            const db = getDB();
            
            if(!db.users[id]) db.users[id] = { name: name, history: {} };
            
            // Verifica se j√° jogou (ignora se for ID 01)
            if(id !== '01' && db.users[id].history[todayKey]) {
                const todayData = db.users[id].history[todayKey];
                showMsg(`Ol√° ${name}! Voc√™ j√° jogou hoje. Pontua√ß√£o: ${todayData.score}. Tente amanh√£!`);
                return;
            }

            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => console.error("Erro ao limpar scanner", error));
                document.getElementById('reader').style.display = "none";
                document.getElementById('btn-camera').textContent = "üì∑ Abrir Leitor QR";
            }

            gameState.user = { id, name };
            gameState.questions = generateBigPool().slice(0, 10);
            gameState.currentIdx = 0;
            gameState.score = 0;
            gameState.strikes = 0;
            gameState.isLocked = false;
            showScreen('screen-game');
            renderGame();
        }

        function showMsg(txt) {
            const el = document.getElementById('msg-login');
            el.textContent = txt;
            el.style.display = 'block';
        }

        // --- GAME LOGIC ---
        function renderGame() {
            if(gameState.strikes >= 3 || gameState.currentIdx >= 10) { endGame(); return; }
            const qData = gameState.questions[gameState.currentIdx];
            
            // NOME E ID GRANDES NO TOPO
            const firstName = gameState.user.name.split(' ')[0].toUpperCase();
            document.getElementById('player-display').textContent = `${gameState.user.id} - ${firstName}`;

            // STATUS ATUALIZADOS
            document.getElementById('strikes-display').textContent = `${gameState.strikes}/3`;
            document.getElementById('q-num-display').textContent = `${gameState.currentIdx + 1}/10`;
            
            document.getElementById('question-text').textContent = qData.q;
            
            const optContainer = document.getElementById('options-list');
            optContainer.innerHTML = '';

            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerHTML = `<div class="option-number">${idx + 1}</div><div class="option-text">${opt}</div>`;
                btn.onclick = () => handleAnswer(idx, btn);
                optContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedIdx, btnElement) {
            if(gameState.isLocked) return;
            gameState.isLocked = true;
            const currentQ = gameState.questions[gameState.currentIdx];
            const isCorrect = selectedIdx === currentQ.correct;

            btnElement.classList.add('blink');
            setTimeout(() => {
                btnElement.classList.remove('blink');
                if(isCorrect) {
                    btnElement.classList.add('correct');
                    gameState.score++;
                } else {
                    btnElement.classList.add('wrong');
                    gameState.strikes++;
                    const correctBtn = document.getElementById('options-list').children[currentQ.correct];
                    if(correctBtn) correctBtn.classList.add('correct');
                }
                setTimeout(() => {
                    gameState.currentIdx++;
                    gameState.isLocked = false;
                    renderGame();
                }, 1500);
            }, 1000);
        }

        function endGame() {
            // 1. Salvamento (try-catch para evitar quebras)
            try {
                const db = getDB();
                const todayKey = new Date().toLocaleDateString();
                if(gameState.user && gameState.user.id) {
                    if(!db.users[gameState.user.id]) {
                         db.users[gameState.user.id] = { name: gameState.user.name, history: {} };
                    }
                    db.users[gameState.user.id].history[todayKey] = { score: gameState.score, date: new Date().toISOString() };
                    saveDB(db);
                }
            } catch(e) {
                console.error("Erro ao salvar:", e);
            }
            
            // 2. Atualiza√ß√£o do DOM (ANTES de mudar a tela)
            try {
                const firstName = gameState.user ? gameState.user.name.split(' ')[0].toUpperCase() : "ALUNO";
                
                const nameEl = document.getElementById('end-player-name');
                const scoreEl = document.getElementById('end-score');
                const strikesEl = document.getElementById('end-strikes');
                const msgEl = document.getElementById('end-msg');

                if(nameEl) nameEl.textContent = firstName;
                if(scoreEl) scoreEl.textContent = gameState.score;
                if(strikesEl) strikesEl.textContent = gameState.strikes;
                
                if(msgEl) {
                    if(gameState.strikes >= 3) {
                        msgEl.textContent = "Que pena! Voc√™ errou 3 vezes.";
                        msgEl.style.color = "var(--red-wrong)";
                    } else {
                        msgEl.textContent = "Parab√©ns! Miss√£o cumprida!";
                        msgEl.style.color = "var(--green-correct)";
                    }
                }
            } catch(e) {
                console.error("Erro ao atualizar DOM final:", e);
            }

            // 3. Troca de Tela (Garante visualiza√ß√£o)
            showScreen('screen-result');
        }

        function logout() { location.reload(); }
        function clearData() {
            if(confirm("Isso apagar√° todo o hist√≥rico. Confirma?")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // --- INTEGRA√á√ÉO HTML5-QRCODE ---
        let html5QrcodeScanner = null;

        function toggleCamera() {
            const readerBox = document.getElementById('reader');
            const manualBox = document.getElementById('manual-box');
            const btn = document.getElementById('btn-camera');

            if (readerBox.style.display === 'none' || readerBox.style.display === '') {
                manualBox.style.display = 'none';
                readerBox.style.display = 'block';
                btn.textContent = "‚ùå Fechar Leitor";

                if (!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                }
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);

            } else {
                closeCameraUI();
            }
        }

        function closeCameraUI() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => console.error(error));
            }
            document.getElementById('reader').style.display = 'none';
            document.getElementById('manual-box').style.display = 'block';
            document.getElementById('btn-camera').textContent = "üì∑ Abrir Leitor QR";
        }

        function onScanSuccess(decodedText, decodedResult) {
            const cleanText = decodedText.replace(/Crisma Juvenil/i, '').trim();
            let id, name;

            if(cleanText.includes('|')) {
                [id, name] = cleanText.split('|');
            } else {
                const parts = cleanText.split(' ');
                if(parts.length >= 2) {
                    id = parts[0];
                    name = parts.slice(1).join(' ');
                }
            }

            if(id && name) {
                document.body.style.backgroundColor = '#fff';
                setTimeout(() => document.body.style.backgroundColor = '', 100);
                document.getElementById('input-id').value = id;
                document.getElementById('input-name').value = name;
                processLogin(id, name);
            }
        }

        function onScanFailure(error) { }
    </script>
</body>
</html>
